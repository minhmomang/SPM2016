$(function($){
	var jssor_1_SlideshowTransitions = [ {
		$Duration : 1200,
		x : 0.3,
		$During : {
			$Left : [ 0.3, 0.7 ]
		},
		$Easing : {
			$Left : $Jease$.$InCubic,
			$Opacity : $Jease$.$Linear
		},
		$Opacity : 2
	}, {
		$Duration : 1200,
		x : -0.3,
		$SlideOut : true,
		$Easing : {
			$Left : $Jease$.$InCubic,
			$Opacity : $Jease$.$Linear
		},
		$Opacity : 2
	}, {
		$Duration : 1200,
		x : -0.3,
		$During : {
			$Left : [ 0.3, 0.7 ]
		},
		$Easing : {
			$Left : $Jease$.$InCubic,
			$Opacity : $Jease$.$Linear
		},
		$Opacity : 2
	}, {
		$Duration : 1200,
		x : 0.3,
		$SlideOut : true,
		$Easing : {
			$Left : $Jease$.$InCubic,
			$Opacity : $Jease$.$Linear
		},
		$Opacity : 2
	}, {
		$Duration : 1200,
		y : 0.3,
		$During : {
			$Top : [ 0.3, 0.7 ]
		},
		$Easing : {
			$Top : $Jease$.$InCubic,
			$Opacity : $Jease$.$Linear
		},
		$Opacity : 2
	}, {
		$Duration : 1200,
		y : -0.3,
		$SlideOut : true,
		$Easing : {
			$Top : $Jease$.$InCubic,
			$Opacity : $Jease$.$Linear
		},
		$Opacity : 2
	}, {
		$Duration : 1200,
		y : -0.3,
		$During : {
			$Top : [ 0.3, 0.7 ]
		},
		$Easing : {
			$Top : $Jease$.$InCubic,
			$Opacity : $Jease$.$Linear
		},
		$Opacity : 2
	}, {
		$Duration : 1200,
		y : 0.3,
		$SlideOut : true,
		$Easing : {
			$Top : $Jease$.$InCubic,
			$Opacity : $Jease$.$Linear
		},
		$Opacity : 2
	}, {
		$Duration : 1200,
		x : 0.3,
		$Cols : 2,
		$During : {
			$Left : [ 0.3, 0.7 ]
		},
		$ChessMode : {
			$Column : 3
		},
		$Easing : {
			$Left : $Jease$.$InCubic,
			$Opacity : $Jease$.$Linear
		},
		$Opacity : 2
	}, {
		$Duration : 1200,
		x : 0.3,
		$Cols : 2,
		$SlideOut : true,
		$ChessMode : {
			$Column : 3
		},
		$Easing : {
			$Left : $Jease$.$InCubic,
			$Opacity : $Jease$.$Linear
		},
		$Opacity : 2
	}, {
		$Duration : 1200,
		y : 0.3,
		$Rows : 2,
		$During : {
			$Top : [ 0.3, 0.7 ]
		},
		$ChessMode : {
			$Row : 12
		},
		$Easing : {
			$Top : $Jease$.$InCubic,
			$Opacity : $Jease$.$Linear
		},
		$Opacity : 2
	}, {
		$Duration : 1200,
		y : 0.3,
		$Rows : 2,
		$SlideOut : true,
		$ChessMode : {
			$Row : 12
		},
		$Easing : {
			$Top : $Jease$.$InCubic,
			$Opacity : $Jease$.$Linear
		},
		$Opacity : 2
	}, {
		$Duration : 1200,
		y : 0.3,
		$Cols : 2,
		$During : {
			$Top : [ 0.3, 0.7 ]
		},
		$ChessMode : {
			$Column : 12
		},
		$Easing : {
			$Top : $Jease$.$InCubic,
			$Opacity : $Jease$.$Linear
		},
		$Opacity : 2
	}, {
		$Duration : 1200,
		y : -0.3,
		$Cols : 2,
		$SlideOut : true,
		$ChessMode : {
			$Column : 12
		},
		$Easing : {
			$Top : $Jease$.$InCubic,
			$Opacity : $Jease$.$Linear
		},
		$Opacity : 2
	}, {
		$Duration : 1200,
		x : 0.3,
		$Rows : 2,
		$During : {
			$Left : [ 0.3, 0.7 ]
		},
		$ChessMode : {
			$Row : 3
		},
		$Easing : {
			$Left : $Jease$.$InCubic,
			$Opacity : $Jease$.$Linear
		},
		$Opacity : 2
	}, {
		$Duration : 1200,
		x : -0.3,
		$Rows : 2,
		$SlideOut : true,
		$ChessMode : {
			$Row : 3
		},
		$Easing : {
			$Left : $Jease$.$InCubic,
			$Opacity : $Jease$.$Linear
		},
		$Opacity : 2
	}, {
		$Duration : 1200,
		x : 0.3,
		y : 0.3,
		$Cols : 2,
		$Rows : 2,
		$During : {
			$Left : [ 0.3, 0.7 ],
			$Top : [ 0.3, 0.7 ]
		},
		$ChessMode : {
			$Column : 3,
			$Row : 12
		},
		$Easing : {
			$Left : $Jease$.$InCubic,
			$Top : $Jease$.$InCubic,
			$Opacity : $Jease$.$Linear
		},
		$Opacity : 2
	}, {
		$Duration : 1200,
		x : 0.3,
		y : 0.3,
		$Cols : 2,
		$Rows : 2,
		$During : {
			$Left : [ 0.3, 0.7 ],
			$Top : [ 0.3, 0.7 ]
		},
		$SlideOut : true,
		$ChessMode : {
			$Column : 3,
			$Row : 12
		},
		$Easing : {
			$Left : $Jease$.$InCubic,
			$Top : $Jease$.$InCubic,
			$Opacity : $Jease$.$Linear
		},
		$Opacity : 2
	}, {
		$Duration : 1200,
		$Delay : 20,
		$Clip : 3,
		$Assembly : 260,
		$Easing : {
			$Clip : $Jease$.$InCubic,
			$Opacity : $Jease$.$Linear
		},
		$Opacity : 2
	}, {
		$Duration : 1200,
		$Delay : 20,
		$Clip : 3,
		$SlideOut : true,
		$Assembly : 260,
		$Easing : {
			$Clip : $Jease$.$OutCubic,
			$Opacity : $Jease$.$Linear
		},
		$Opacity : 2
	}, {
		$Duration : 1200,
		$Delay : 20,
		$Clip : 12,
		$Assembly : 260,
		$Easing : {
			$Clip : $Jease$.$InCubic,
			$Opacity : $Jease$.$Linear
		},
		$Opacity : 2
	}, {
		$Duration : 1200,
		$Delay : 20,
		$Clip : 12,
		$SlideOut : true,
		$Assembly : 260,
		$Easing : {
			$Clip : $Jease$.$OutCubic,
			$Opacity : $Jease$.$Linear
		},
		$Opacity : 2
	} ];

	var jssor_1_options = {
		$AutoPlay : true,
		$SlideshowOptions : {
			$Class : $JssorSlideshowRunner$,
			$Transitions : jssor_1_SlideshowTransitions,
			$TransitionsOrder : 1
		},
		$ArrowNavigatorOptions : {
			$Class : $JssorArrowNavigator$
		},
		$ThumbnailNavigatorOptions : {
			$Class : $JssorThumbnailNavigator$,
			$Cols : 4,
			$SpacingX : 8,
			$SpacingY : 8,
			$Align : 360
		}
	};
	function ScaleSlider(jssor_1_slider) {
		try{
			var refSize = jssor_1_slider.$Elmt.parentNode.clientWidth;
			if (refSize) {
				refSize = Math.min(refSize, 600);
				jssor_1_slider.$ScaleWidth(refSize);
			} else {
				window.setTimeout(ScaleSlider, 30);
			}
		}catch(ex){}
		
	}
	
	/*******************************************************************************************************/
	
	var user_id='';
	var email='';
	var p_id = getUrlParameter('id');
	
	function show_login(){
		$("#dialoglogin1").dialog({
			 height: 390,
			 width: 650,
			 modal: true ,
			 autoOpen: true ,
			 title:'Đăng nhập VMALL',
			 resizable: false ,
			 buttons: {	   			
				"Đăng nhập": function() {
					  var p_email = $("#txtemail1").val();
					  var p_pass = $("#txtpassword1").val();
					  blockbg();
						var pdata = {
							'email':p_email,
							'pass':p_pass,
							'cookies':"N"
						};
						exec_check_login(pdata);
				},
				"Đóng": function() {
				   $(this).dialog("close");
			   }
			
			}
		});
	}
	function exec_check_login(pdata){
		
		Return_get('MemberController','check_login',pdata,'GET',function(data){		
			unblockbg();
			if(data!=null){					
				var error = data.error;
				if(error==1){		
				/*	$("#infologincomment_"+data.subid).css('display','none');
					p_idemail = data.id;
					p_fullname_main  = data.fullname;
					p_shortfullname = data.shortname;
					$("#infosend_"+data.subid).css('display','block');
					$("#infologincomment_"+data.subid).css('display','none');
					$("#txtemail").val('');
					$("#txtpassword").val('');
					 */
					showdialogfunctionok('dialogmanual1', 'Đăng nhập thành công.', function(){
						location.reload();
					});
				
					
				}
				else if(error==2){								
					show_message_basic('dialogmanual1','Tài khoản chưa xác nhận, vui lòng xác nhận!.');
				}
				else{
					show_message_basic('dialogmanual1','Đăng nhập không thành công.');
				}
			}
		});
	}
	
	exe_load_header_detail_product(function(out){
		if(out==true){
			var id = getUrlParameter('id');
			if(id==null || id==undefined){
				showdialogfunctionok('dialogmanual','Không có sản phẩm, vui lòng chọn sản phẩm khác!',function(){
					window.location.href=ReturnHosing_apache()+"index.html";
				});
				return;
			}				
			load_info_product(function(out){
				if(out==true){
					var jssor_1_slider = new $JssorSlider$("jssor_1", jssor_1_options);
					ScaleSlider(jssor_1_slider);
					$(window).bind("load", ScaleSlider);
					$(window).bind("resize", ScaleSlider);
					$(window).bind("orientationchange", ScaleSlider);
					load_product_related(id);
					//load total comment default
					$("#total_comment").text('Loading total comment ...');
					get_total_comment(id);
					setInterval(function(){
						$("#total_comment").text('Loading total comment ...');
						get_total_comment(id);
					},50000);
					//save history
					write_log(function(out){
						if(out){					
							
						}
					},id);
				}
				else{
					showdialogfunctionok('dialogmanual','Sản phẩm không còn kinh doanh. Vui lòng chọn sản phẩm khác',function(){
						window.location.href=ReturnHosing_apache()+"index.html";
					});
					return;
				}
			});
			
		}
	});
	
	function load_product_related(id){
		
		var pdata = {
				'productid':id
		};
		Return_get("ProductController","get_list_product_related",pdata,"GET",function(data){
			if(data!=null){
				load_text(function(str){
					for(var i=0;i<data.length;i++)
					{
						var html = str;
						html = html.replace('@src',ReturnHosing_tomcat()+'upload/product/'+data[i].productImage);
						html = html.replace('@name',data[i].productName);
						html = html.replace('@href','detailProduct.html?id='+data[i].productId);
						$("#carouselv").append(html);
					}
					
				});
				
			}
		});
	}
	function load_text(callback){
		var url = ReturnHosing_apache()+'txt/product_new.txt';
		$.get(url,function(data){
			callback(data);
		});
	}
	function get_total_comment(id){
		
		var pdata ={
				'product':id
		};
		Return_get("CommentController","get_total_comment_by_product",pdata,"GET",function(data){
			$("#total_comment").text('( Có '+data.result+' bình luận )');
		});
	}
	function load_info_product(callback){
		var id = getUrlParameter('id');
		var pdata ={
				'id':id
		};
		Return_get("ProductController","get_info_product",pdata,"GET",function(data){
			if(data!=null){
				if(data.productId==undefined){
					callback(false);
				}
				else{
					if(data.isPromo!='0'){
						$("#block_promo").css('display','block');
					}
					else{
						$("#block_promo").css('display','none');
					}
					$("#product_name").text(data.productName);				
					$("#price_old").text(formatcurrency(data.price_old));
					$("#product_price").text(formatcurrency(data.productPrice));
						//default load des
					$("#product_desc").html(data.productDes);				
					$("#des_short").html((data.productDescShort)).show();
					//$("#info_guide").html(htmlUnescape(data.productguide)).show();
					$("#more_info").html(htmlUnescape(data.moreinfo)).show();
					//$("#info_guide_mobile").html(htmlUnescape(data.productguide)).show();
					var urlimg = ReturnHosing_tomcat()+'upload/product/'+data.productImage;
					
					$("#imgshow").html('');
					$("#imgshow").append(get_html_parrent_imgitem(urlimg));
					//$("#info_guide").css('display','none');	
					//$("#contain_image_mobile_product").attr('src',urlimg);
				
					Return_get("ProductController","get_image_product",pdata,"GET",function(data){
							if(data!=null){
								$.map(data,function(item){
									var urlimg = ReturnHosing_tomcat()+'upload/product/'+item.productImage;
									$("#imgshow").append(get_html_imgitem(urlimg));
								});
								callback(true);
							}
					});		
					callback(true);
				}		
			
				
			}
		});		
	}
	
	function get_html_parrent_imgitem(imge){
		var ht='<div style="display: none;border: 1px solid lightgray;">'
			  +'<img data-u="image" src="'+imge+'" />'
			  +'<img data-u="thumb"src="'+imge+'" class="img-responsive" /></div>';
		return ht;
	}
	function get_html_imgitem(imge){
		var ht='<div data-p="144" style="display: none;">'
			+'<img data-u="image" src="'+imge+'" /> '
			+'<img data-u="thumb"src="'+imge+'" /></div>';
		return ht;
	}

	$("#btnvote").click(
		    function() {

		        var width = $(".rating-stars").css('width');
		        		        
		        width = width.substr(0, width.length - 2);
		        var star = 0;
		        if (width <= 39) {
		            star = 1;
		        } else if (width <= 79) {
		            star = 2;
		        } else if (width <= 118) {
		            star = 3;
		        } else if (width <= 158) {
		            star = 4;
		        } else if (width <= 197) {
		            star = 5;
		        }		        
		        //
		        var idproduct = getUrlParameter('id');
		        if (idproduct == null || idproduct == 'undefined') {
		        	alert('Mã sản phẩm rổng không thể bình chọn');		            
		            return;
		        }
		        
		        var pdata = {
		        		'id': idproduct,
			            'rating': star
		        };
		        Return_get("ProductController","rating_product",pdata,"GET",function(data){
		        	if (data != null) {
		                if (parseInt(data) == 0) {
		                    $("#btnvote").css('display','none');
		                    showdialog('dialogmanual',0,'Bình chọn thành công','','');		                    
		                    return;
		                } else {
		                	showdialog('dialogmanual',0,'Bình chọn không thành công','','');
		                    return;
		                }
		            } else {
		            	showdialog('dialogmanual',0,'Bình chọn không thành công','','');
		                return;
		            }	
				});
		       
		    });
	$("#btnnews").click(function(){
		var idproduct = getUrlParameter('id');
		Return_get('MemberController','get_info_login','','GET',function(data){
			if(data!=null || data!=''){
				email=data.result;
				if(email==null || email==''){
					showdialogfunctionok('dialogmanual1', 'Bạn chưa đăng nhập, vui lòng đăng nhập.', function(){
						if(ismobile()){
						window.location.href=ReturnHosing_apache()+"signin.html";	
						}
						else{
							show_login();							
						}
					});
				}
				else{
					/*pdata={'email':email};
					Return_get("MemberController","get_id_by_email",pdata,"GET",function(data){
						if(data!=null){
							user_id=data.id;*/
							pdata={
									'email':email,
									//'user_id':user_id,
									'product_id':idproduct
							}
							Return_get("MemberController","register_product_news",pdata,"GET",function(data){
								if(data!=null)
									{
									var result = data.result;
									if(result=="0"){
										showdialog('dialogmanual',0,'Đăng ký nhận tin thành công','','');
										$("#btnnews").css('display','none');
										return;
										}
									}
									if(result=="-1"){
										showdialog('dialogmanual',0,'Đăng ký nhận tin thất bại','','');
										return;
									}
									if(result=="-2"){
										showdialog('dialogmanual',0,'Bạn đã đăng ký cho sản phẩm này','','');
										return;
									}
							});
						//}
					//});
				}
			}
			else{
				showdialog('dialogmanual',0,'Đăng ký không thành công','','');
                return;
			}
		});
		
	});
	function write_log(callback,productid){
		
		$.get("http://ipinfo.io", function(response) {
			var ip = response.ip;
			var hostname = response.hostname;
			var city = response.city;
			var region = response.region;
			var country = response.country;
			var loc = response.loc;
			var org = response.org;
			var obj = {
				'ip':ip,
				'hostname':hostname,
				'city':city,
				'region':region,
				'country':country,
				'loc':loc,
				'org':org,				
				'productid':productid
			};
			var pdata = {
					'str':JSON.stringify(obj)
			};
			Return_get('ProductController','write_log_product',pdata,'GET',function(data){				
				if(data!=null){					
					var error = data.error;
					if(error==0){			
						callback(true);			
					}
					else{
						callback(false);
					}
				}
			});
		}, "jsonp");
	}
	
});